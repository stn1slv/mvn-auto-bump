#!/usr/bin/env bash
set -euo pipefail

# Only run when pom.xml exists at repo root
if [ ! -f "pom.xml" ]; then
  exit 0
fi

# Optional safety: do nothing if this commit already staged pom.xml changes.
# Comment this block out if you truly want to bump on every single commit no matter what.
if git diff --cached --name-only | grep -qx "pom.xml"; then
  # If pom.xml is already staged, do not auto-bump to avoid surprising extra changes.
  exit 0
fi

# Bump patch version without -SNAPSHOT
mvn -q build-helper:parse-version versions:set \
  -DnewVersion=\${parsedVersion.majorVersion}.\${parsedVersion.minorVersion}.\${parsedVersion.nextIncrementalVersion} \
  -DgenerateBackupPoms=false
mvn -q versions:commit

# Stage the updated pom so the commit includes it
git add pom.xml

# Continue the commit
exit 0